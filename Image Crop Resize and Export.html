<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fancy Advanced Cropper</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f0f2f5;
      padding: 20px;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 20px;
      border-radius: 12px;
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    .tools {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }
    .tools label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .tools input, .tools select, .tools button {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    .tools button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    .tools button:hover {
      background-color: #0056b3;
    }
    #canvasContainer {
      position: relative;
      display: inline-block;
      margin-bottom: 20px;
    }
    canvas {
      max-width: 100%;
      border: 1px solid #ccc;
      touch-action: none;
      border-radius: 6px;
    }
    .selection {
      position: absolute;
      border: 2px dashed red;
      pointer-events: none;
      z-index: 10;
      display: none;
    }
    .preview-box {
      border: 1px solid #aaa;
      padding: 10px;
      margin-top: 10px;
      max-width: 300px;
      border-radius: 8px;
    }
    .preview-box h4 {
      margin: 0 0 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Advanced Image Cropper & Resizer</h2>

  <div class="tools">
    <input type="file" id="fileInput" accept="image/*" />
    
    <button onclick="startCrop()">Start Crop</button>
    <button onclick="cropImage()">Crop</button>
    <button onclick="cropThenResize()">Crop & Resize</button>

    <label>Aspect:
      <select id="aspectRatioPreset" onchange="updateAspectPreset()">
        <option value="free">Free</option>
        <option value="1:1">1:1</option>
        <option value="16:9">16:9</option>
        <option value="4:3">4:3</option>
        <option value="3:2">3:2</option>
      </select>
    </label>

    <label>Resize:
      <input type="number" id="resizeWidth" value="300" min="10" />
      Ã—
      <input type="number" id="resizeHeight" value="300" min="10" />
      <select id="resizeUnit">
        <option value="px">px</option>
        <option value="mm">mm</option>
        <option value="cm">cm</option>
      </select>
    </label>

    <button onclick="resizeOnly()">Resize Only</button>

    <label>Download as:
      <select id="formatSelect">
        <option value="png">PNG</option>
        <option value="jpeg">JPG</option>
        <option value="webp">WebP</option>
        <option value="pdf">PDF</option>
      </select>
    </label>

    <button onclick="downloadCroppedImage()">Download</button>
  </div>

  <div id="canvasContainer">
    <canvas id="imageCanvas"></canvas>
    <div id="selectionBox" class="selection"></div>
  </div>

  <div class="preview-box" id="previewBox" style="display:none;">
    <h4>Live Preview</h4>
    <canvas id="previewCanvas" width="200" height="200"></canvas>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const canvas = document.getElementById("imageCanvas");
  const ctx = canvas.getContext("2d");
  const fileInput = document.getElementById("fileInput");
  const resizeWidth = document.getElementById("resizeWidth");
  const resizeHeight = document.getElementById("resizeHeight");
  const resizeUnit = document.getElementById("resizeUnit");
  const selectionBox = document.getElementById("selectionBox");
  const aspectPreset = document.getElementById("aspectRatioPreset");
  const previewCanvas = document.getElementById("previewCanvas");
  const previewCtx = previewCanvas.getContext("2d");

  let img = new Image();
  let isCropping = false;
  let isDragging = false;
  let croppedCanvas = null;
  let startX = 0, startY = 0, endX = 0, endY = 0;
  let aspectRatio = null;

  fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        clearPreview();
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  });

  function getMouse(e) {
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    return { x, y };
  }

  canvas.addEventListener("mousedown", e => {
    if (!isCropping) return;
    const pos = getMouse(e);
    startX = endX = pos.x;
    startY = endY = pos.y;
    updateAspectPreset();
    isDragging = true;
    drawBox();
  });

  canvas.addEventListener("mousemove", e => {
    if (!isCropping || !isDragging) return;
    const pos = getMouse(e);

    if (aspectRatio) {
      let w = pos.x - startX;
      let h = w / aspectRatio;

      if ((pos.y - startY) < 0) h = -Math.abs(h);
      else h = Math.abs(h);

      endX = startX + w;
      endY = startY + h;
    } else {
      endX = pos.x;
      endY = pos.y;
    }
    drawBox();
  });

  ["mouseup", "mouseleave"].forEach(event =>
    canvas.addEventListener(event, () => {
      if (!isCropping) return;
      isDragging = false;
      updatePreview();
    })
  );

  canvas.addEventListener("touchstart", e => {
    if (!isCropping) return;
    const pos = getMouse(e);
    startX = endX = pos.x;
    startY = endY = pos.y;
    updateAspectPreset();
    isDragging = true;
    drawBox();
  });

  canvas.addEventListener("touchmove", e => {
    if (!isCropping || !isDragging) return;
    const pos = getMouse(e);

    if (aspectRatio) {
      let w = pos.x - startX;
      let h = w / aspectRatio;
      if ((pos.y - startY) < 0) h = -Math.abs(h);
      else h = Math.abs(h);
      endX = startX + w;
      endY = startY + h;
    } else {
      endX = pos.x;
      endY = pos.y;
    }
    drawBox();
  });

  canvas.addEventListener("touchend", () => {
    if (!isCropping) return;
    isDragging = false;
    updatePreview();
  });

  function drawBox() {
    const x = Math.min(startX, endX);
    const y = Math.min(startY, endY);
    const w = Math.abs(endX - startX);
    const h = Math.abs(endY - startY);
    selectionBox.style.left = x + "px";
    selectionBox.style.top = y + "px";
    selectionBox.style.width = w + "px";
    selectionBox.style.height = h + "px";
    selectionBox.style.display = "block";
  }

  function startCrop() {
    isCropping = true;
    selectionBox.style.display = "none";
    clearPreview();
  }

  function updateAspectPreset() {
    const val = aspectPreset.value;
    if (val === "free") {
      aspectRatio = null;
    } else {
      const [w, h] = val.split(":").map(Number);
      aspectRatio = w / h;
    }
  }

  function convertToPixels(value, unit) {
    const dpi = 96;
    if (unit === "px") return value;
    if (unit === "mm") return value * (dpi / 25.4);
    if (unit === "cm") return value * (dpi / 2.54);
  }

  function cropImage() {
    if (startX === endX || startY === endY) {
      alert("No area selected to crop!");
      return;
    }
    const x = Math.min(startX, endX);
    const y = Math.min(startY, endY);
    const w = Math.abs(endX - startX);
    const h = Math.abs(endY - startY);

    const outW = convertToPixels(parseFloat(resizeWidth.value), resizeUnit.value);
    const outH = convertToPixels(parseFloat(resizeHeight.value), resizeUnit.value);

    croppedCanvas = document.createElement("canvas");
    croppedCanvas.width = outW;
    croppedCanvas.height = outH;
    const croppedCtx = croppedCanvas.getContext("2d");
    croppedCtx.drawImage(canvas, x, y, w, h, 0, 0, outW, outH);

    updatePreview();
    isCropping = false;
    selectionBox.style.display = "none";
  }

  // NEW function: crop THEN resize
  function cropThenResize() {
    if (startX === endX || startY === endY) {
      alert("No area selected to crop!");
      return;
    }

    const x = Math.min(startX, endX);
    const y = Math.min(startY, endY);
    const w = Math.abs(endX - startX);
    const h = Math.abs(endY - startY);

    // First crop the original canvas without resizing
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = w;
    tempCanvas.height = h;
    const tempCtx = tempCanvas.getContext("2d");
    tempCtx.drawImage(canvas, x, y, w, h, 0, 0, w, h);

    // Now resize the cropped image to user dimensions
    const outW = convertToPixels(parseFloat(resizeWidth.value), resizeUnit.value);
    const outH = convertToPixels(parseFloat(resizeHeight.value), resizeUnit.value);

    croppedCanvas = document.createElement("canvas");
    croppedCanvas.width = outW;
    croppedCanvas.height = outH;
    const croppedCtx = croppedCanvas.getContext("2d");

    croppedCtx.drawImage(tempCanvas, 0, 0, w, h, 0, 0, outW, outH);

    updatePreview();
    isCropping = false;
    selectionBox.style.display = "none";
  }

  function updatePreview() {
    if (!croppedCanvas) return;
    const scale = 200 / croppedCanvas.width;
    previewCanvas.width = 200;
    previewCanvas.height = croppedCanvas.height * scale;
    previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
    previewCtx.drawImage(croppedCanvas, 0, 0, previewCanvas.width, previewCanvas.height);
    document.getElementById("previewBox").style.display = "block";
  }

  function clearPreview() {
    previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
    document.getElementById("previewBox").style.display = "none";
  }

  function resizeOnly() {
    if (!img.src) {
      alert("Upload an image first.");
      return;
    }
    const outW = convertToPixels(parseFloat(resizeWidth.value), resizeUnit.value);
    const outH = convertToPixels(parseFloat(resizeHeight.value), resizeUnit.value);

    croppedCanvas = document.createElement("canvas");
    croppedCanvas.width = outW;
    croppedCanvas.height = outH;
    const ctx2 = croppedCanvas.getContext("2d");
    ctx2.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, outW, outH);

    updatePreview();
  }

  function downloadCroppedImage() {
    if (!croppedCanvas) {
      alert("Nothing to download! Please crop or resize first.");
      return;
    }
    const format = document.getElementById("formatSelect").value;

    if (format === "pdf") {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const imgData = croppedCanvas.toDataURL("image/jpeg");
      const pdfWidth = 180;
      const pdfHeight = (croppedCanvas.height / croppedCanvas.width) * pdfWidth;
      pdf.addImage(imgData, "JPEG", 15, 15, pdfWidth, pdfHeight);
      pdf.save("cropped-image.pdf");
    } else {
      const link = document.createElement("a");
      link.download = "cropped-image." + format;
      link.href = croppedCanvas.toDataURL("image/" + format);
      link.click();
    }
  }
</script>

</body>
</html>
