<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Image Crop & Resize Tool</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; background: #f0f0f0; }
    canvas { border: 1px solid #ccc; max-width: 100%; margin-top: 10px; touch-action: none; }
    .row { margin: 10px 0; }
    input, button, select { padding: 6px; font-size: 16px; }
    button:disabled { opacity: 0.5; }
    .note { font-size: 14px; color: #555; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>üñºÔ∏è Image Crop & Resize Tool</h2>

  <div class="row">
    <input type="file" id="fileInput" accept="image/*">
  </div>

  <div class="row">
    <button id="removeBgBtn" disabled>Remove Background</button>
    <button id="downloadBtn" disabled>Download Image</button>
  </div>

  <div class="row">
    <label for="aspect">Aspect Ratio:</label>
    <select id="aspect">
      <option value="free">Free</option>
      <option value="1:1">1:1</option>
      <option value="4:3">4:3</option>
      <option value="16:9">16:9</option>
    </select>
    <button id="cropBtn" disabled>‚úÇÔ∏è Crop Image</button>
    <span class="note">Click and drag to crop area</span>
  </div>

  <div class="row">
    <label>Resize:</label>
    <input type="number" id="widthInput" placeholder="Width" style="width:80px;">
    <input type="number" id="heightInput" placeholder="Height" style="width:80px;">
    <button id="resizeBtn" disabled>‚Üî Resize</button>
  </div>

  <canvas id="canvas"></canvas>

  <p id="status"></p>

  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const removeBgBtn = document.getElementById('removeBgBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const resizeBtn = document.getElementById('resizeBtn');
    const widthInput = document.getElementById('widthInput');
    const heightInput = document.getElementById('heightInput');
    const cropBtn = document.getElementById('cropBtn');
    const aspectSelect = document.getElementById('aspect');
    const statusEl = document.getElementById('status');

    let originalImage = null;
    let bgRemovedImage = null;
    let imageBackup = null;
    let cropping = false;
    let cropStart = null;
    let cropEnd = null;

    function drawImage(image) {
      canvas.width = image.width;
      canvas.height = image.height;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0);
    }

    function drawResized() {
      const w = parseInt(widthInput.value);
      const h = parseInt(heightInput.value);
      if (!w || !h) return;
      canvas.width = w;
      canvas.height = h;
      ctx.clearRect(0, 0, w, h);
      ctx.drawImage(bgRemovedImage || originalImage, 0, 0, w, h);
    }

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        const img = new Image();
        img.onload = () => {
          originalImage = img;
          bgRemovedImage = null;
          imageBackup = img;
          widthInput.value = img.width;
          heightInput.value = img.height;
          drawImage(img);
          removeBgBtn.disabled = false;
          downloadBtn.disabled = false;
          resizeBtn.disabled = false;
          cropBtn.disabled = false;
          statusEl.textContent = "Image loaded.";
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });

    removeBgBtn.addEventListener('click', async () => {
      statusEl.textContent = "Removing background...";
      const formData = new FormData();
      formData.append("image_file", fileInput.files[0]);
      formData.append("size", "auto");
      const res = await fetch("https://api.remove.bg/v1.0/removebg", {
        method: "POST",
        headers: { "X-Api-Key": "INSERT_YOUR_API_KEY_HERE" },
        body: formData
      });
      const blob = await res.blob();
      const img = new Image();
      img.onload = () => {
        bgRemovedImage = img;
        imageBackup = img;
        drawImage(img);
        statusEl.textContent = "Background removed ‚úî";
      };
      img.src = URL.createObjectURL(blob);
    });

    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = "edited-image.png";
      link.href = canvas.toDataURL();
      link.click();
    });

    resizeBtn.addEventListener('click', () => {
      drawResized();
      statusEl.textContent = "Image resized ‚úî";
    });

    cropBtn.addEventListener('click', () => {
      cropping = true;
      cropStart = null;
      cropEnd = null;
      canvas.style.cursor = 'crosshair';
      statusEl.textContent = "Cropping mode: drag to select area.";
    });

    function getAspectRatio() {
      const value = aspectSelect.value;
      if (value === "free") return null;
      const [w, h] = value.split(':').map(Number);
      return w / h;
    }

    canvas.addEventListener('mousedown', e => {
      if (!cropping) return;
      const rect = canvas.getBoundingClientRect();
      cropStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    });

    canvas.addEventListener('mousemove', e => {
      if (!cropping || !cropStart) return;
      const rect = canvas.getBoundingClientRect();
      let x = e.clientX - rect.left;
      let y = e.clientY - rect.top;
      let aspect = getAspectRatio();

      let dx = x - cropStart.x;
      let dy = y - cropStart.y;

      if (aspect) {
        if (Math.abs(dx) > Math.abs(dy)) {
          dy = Math.sign(dy) * Math.abs(dx) / aspect;
        } else {
          dx = Math.sign(dx) * Math.abs(dy) * aspect;
        }
        x = cropStart.x + dx;
        y = cropStart.y + dy;
      }

      cropEnd = { x, y };

      drawImage(imageBackup);
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 2;
      ctx.setLineDash([6]);
      ctx.strokeRect(
        cropStart.x,
        cropStart.y,
        cropEnd.x - cropStart.x,
        cropEnd.y - cropStart.y
      );
      ctx.setLineDash([]);
    });

    canvas.addEventListener('mouseup', () => {
      if (!cropping || !cropStart || !cropEnd) return;
      cropping = false;
      canvas.style.cursor = 'default';

      let x = Math.min(cropStart.x, cropEnd.x);
      let y = Math.min(cropStart.y, cropEnd.y);
      let w = Math.abs(cropEnd.x - cropStart.x);
      let h = Math.abs(cropEnd.y - cropStart.y);

      if (w < 5 || h < 5) {
        statusEl.textContent = "Crop area too small.";
        return;
      }

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = w;
      tempCanvas.height = h;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(canvas, x, y, w, h, 0, 0, w, h);

      const img = new Image();
      img.onload = () => {
        originalImage = img;
        bgRemovedImage = null;
        imageBackup = img;
        canvas.width = w;
        canvas.height = h;
        widthInput.value = w;
        heightInput.value = h;
        ctx.clearRect(0, 0, w, h);
        ctx.drawImage(img, 0, 0);
        statusEl.textContent = "Image cropped ‚úî";
      };
      img.src = tempCanvas.toDataURL();
    });
  </script>
</body>
</html>
